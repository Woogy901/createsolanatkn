<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Create a Solana Token with Debug Logging</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      label, input, button {
        display: block;
        margin: 0.5rem 0;
      }
      input {
        padding: 0.5rem;
        width: 100%;
        max-width: 300px;
      }
      button {
        padding: 0.5rem 1rem;
        cursor: pointer;
      }
      #result p {
        background: #eef;
        padding: 0.5rem;
        border: 1px solid #ccd;
      }
    </style>
  </head>
  <body>
    <h1>Create a Solana Token</h1>
    <div id="wallet-connection">
      <button id="connectWalletButton">Connect Wallet (Phantom)</button>
      <p id="walletAddress"></p>
    </div>

    <div id="tokenForm" style="display: none;">
      <h2>Token Parameters</h2>
      <label for="decimals">Decimals:</label>
      <input type="number" id="decimals" value="0" min="0" max="9" />
      <button id="createTokenButton">Create Token on Devnet</button>
    </div>

    <div id="result"></div>

    <!-- Using JavaScript modules from a CDN -->
    <script type="module">
      // Import necessary functions from the Solana libraries
      import {
        Connection,
        clusterApiUrl,
        Keypair,
        SystemProgram,
        Transaction
      } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.2/+esm";
      import {
        TOKEN_PROGRAM_ID,
        MintLayout,
        createInitializeMintInstruction
      } from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/+esm";

      // UI Elements
      const connectWalletButton = document.getElementById("connectWalletButton");
      const walletAddressDisplay = document.getElementById("walletAddress");
      const tokenForm = document.getElementById("tokenForm");
      const createTokenButton = document.getElementById("createTokenButton");
      const resultDiv = document.getElementById("result");

      // Global variable to hold the wallet (Phantom) object
      let wallet = null;

      // Debug function to log messages
      function debugLog(message) {
        console.log("[DEBUG]", message);
      }

      // Function to connect to the Phantom Wallet with debugging
      async function connectWallet() {
        debugLog("Attempting to connect wallet...");
        if (window.solana && window.solana.isPhantom) {
          try {
            debugLog("Phantom wallet detected.");
            const response = await window.solana.connect();
            debugLog("Wallet connection response: " + JSON.stringify(response));
            wallet = window.solana;
            walletAddressDisplay.textContent =
              "Connected: " + response.publicKey.toString();
            tokenForm.style.display = "block";
            debugLog("Wallet connected and token form displayed.");
          } catch (err) {
            console.error("Wallet connection error:", err);
            walletAddressDisplay.textContent = "Wallet connection failed: " + err.message;
          }
        } else {
          console.warn("Phantom wallet not found.");
          alert("Phantom wallet not found. Please install it from https://phantom.app");
        }
      }

      connectWalletButton.addEventListener("click", connectWallet);

      // Function to create a new token mint on the Solana Devnet with debugging
      async function createToken() {
        debugLog("createToken() called");
        if (!wallet) {
          alert("Please connect your wallet first.");
          debugLog("Wallet not connected; aborting token creation.");
          return;
        }

        const decimals = parseInt(document.getElementById("decimals").value);
        debugLog("Token decimals: " + decimals);

        // Establish a connection to the Devnet
        const connection = new Connection(clusterApiUrl("devnet"), "confirmed");
        debugLog("Connected to Solana Devnet.");

        // Generate a new keypair for the token mint
        const mintKeypair = Keypair.generate();
        debugLog("Generated new mint keypair: " + mintKeypair.publicKey.toString());

        // Determine the minimum balance for rent exemption
        const lamports = await connection.getMinimumBalanceForRentExemption(MintLayout.span);
        debugLog("Minimum balance for rent exemption: " + lamports + " lamports");

        // Create a transaction with instructions
        let transaction = new Transaction();
        transaction.add(
          SystemProgram.createAccount({
            fromPubkey: wallet.publicKey,
            newAccountPubkey: mintKeypair.publicKey,
            space: MintLayout.span,
            lamports,
            programId: TOKEN_PROGRAM_ID,
          })
        );
        transaction.add(
          createInitializeMintInstruction(
            mintKeypair.publicKey,
            decimals,
            wallet.publicKey,
            wallet.publicKey
          )
        );

        transaction.feePayer = wallet.publicKey;
        const { blockhash } = await connection.getRecentBlockhash();
        transaction.recentBlockhash = blockhash;
        debugLog("Transaction prepared with blockhash: " + blockhash);

        // Partially sign the transaction with the mint keypair
        transaction.partialSign(mintKeypair);
        debugLog("Transaction partially signed with mint keypair.");

        try {
          debugLog("Requesting wallet to sign the transaction...");
          const signedTransaction = await wallet.signTransaction(transaction);
          debugLog("Transaction signed by wallet.");
          const txid = await connection.sendRawTransaction(signedTransaction.serialize());
          debugLog("Transaction sent, txid: " + txid);
          await connection.confirmTransaction(txid, "confirmed");
          debugLog("Transaction confirmed.");

          resultDiv.innerHTML = `
            <p><strong>Token created successfully!</strong></p>
            <p>Mint Address: <code>${mintKeypair.publicKey.toString()}</code></p>
            <p>Transaction ID: <a href="https://explorer.solana.com/tx/${txid}?cluster=devnet" target="_blank">${txid}</a></p>
          `;
        } catch (err) {
          console.error("Error creating token:", err);
          resultDiv.textContent = "Error creating token: " + err.message;
        }
      }

      createTokenButton.addEventListener("click", createToken);
    </script>
  </body>
</html>
